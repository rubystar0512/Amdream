import{u as ae,r as s,y as l,j as t,L as se,a as u}from"./index-C9oXW-tM.js";import{u as ne,E as re,D as oe,C as le,M as c,L as n,S as y,T as M,B as D}from"./usePermission-C2zUwgS5.js";import{d as $,D as O}from"./index-DEEIAA09.js";import{P as de}from"./papaparse.min-B9zVgrBi.js";import{u as ie}from"./useAuth-vkt3PbyG.js";import{S as ue,B as U,T as me}from"./Table-DdFPMSYR.js";import"./index-DRR3yZ9n.js";const fe=()=>{var R;const L=ae(),{permissions:o,loading_1:T}=ne("/payments"),E=ie(),[F,b]=s.useState([]),[Y,H]=s.useState([]),[B,V]=s.useState([]),[h,p]=s.useState(""),[x,g]=s.useState(""),[v,f]=s.useState(""),[j,_]=s.useState(""),[S,C]=s.useState(""),[Z,P]=s.useState(!1),[G,w]=s.useState(!1),[q,z]=s.useState(null),[J,A]=s.useState(!1),[m,k]=s.useState(null);let I=["Credit card","PayPal","Zelle","CashApp"];s.useEffect(()=>{T||(o.read?(async()=>{var a;A(!0);try{const[r,d,i]=await Promise.all([((a=E.user)==null?void 0:a.role)==="student"?u.get(`/payments/student/${E.user.id}`):u.get("/payments"),u.get("/students"),u.get("/class-types")]);b(r.data.payments||[]),H(d.data||[]),V(i.data||[]),A(!1)}catch(r){console.error("Error fetching data:",r),N(r),A(!1)}})():(L("/"),l.error("You don't have permission to view this page",{theme:"dark"})))},[o,L,T]);const K=async()=>{if(!h||!x||!j||!S||!v||!m){l.error("All fields are required.",{theme:"dark"});return}try{const e=await u.post("/payments",{student_id:h,class_type_id:x,amount:j,num_lessons:S,payment_method:v,paymentDate:m.format("YYYY-MM-DD")});b([...e.data.payments]),p(""),g(""),f(""),_(""),C(""),k(null),P(!1),l.success("Payment added successfully!",{theme:"dark"})}catch(e){console.error("Error creating payment:",e),N(e)}},Q=async e=>{try{await u.delete(`/payments/${e}`),b(a=>a.filter(r=>r.id!==e)),l.success("Payment deleted successfully!",{theme:"dark"})}catch(a){console.error("Error deleting payment:",a),N(a)}},W=e=>{z(e),p(e.Student.id.toString()),g(e.class_type.id.toString()),f(e.payment_method),_(e.amount.toString()),C(e.num_lessons.toString()),k(e.payment_date?$(e.payment_date):null),w(!0)},X=async()=>{if(q)try{const e=await u.put(`/payments/${q.id}`,{student_id:h,class_type_id:x,amount:j,num_lessons:S,payment_method:v,paymentDate:m?m.format("YYYY-MM-DD"):null});b([...e.data.payments]),w(!1),z(null),k(null),l.success("Payment updated successfully!",{theme:"dark"})}catch(e){console.error("Error updating payment:",e),N(e)}},N=e=>{e.response?e.response.status===401?(localStorage.removeItem("token"),l.error("Session expired. Please login again.",{theme:"dark"}),L("/")):l.error("Failed to perform the action. Please try again.",{theme:"dark"}):l.error("Network error. Please check your connection.",{theme:"dark"})},ee=()=>{if(F.length===0){l.error("No data available to download.",{theme:"dark"});return}const e=F.map(i=>({"Student Name":`${i.Student.first_name} ${i.Student.last_name}`,"Class Type":i.class_type.name,Amount:i.amount,"Number of Lessons":i.num_lessons})),a=de.unparse(e),r=new Blob([a],{type:"text/csv;charset=utf-8;"}),d=document.createElement("a");d.href=URL.createObjectURL(r),d.download="payments.csv",document.body.appendChild(d),d.click(),document.body.removeChild(d)},te=[{title:"No",dataIndex:"index",key:"index",width:"8%",render:(e,a,r)=>r+1},{title:"Student",key:"student",render:(e,a)=>`${a.Student.first_name} ${a.Student.last_name}`,sorter:(e,a)=>`${e.Student.first_name} ${e.Student.last_name}`.localeCompare(`${a.Student.first_name} ${a.Student.last_name}`),...((R=E.user)==null?void 0:R.role)!=="student"&&{filters:Y.map(e=>({text:`${e.first_name} ${e.last_name}`,value:`${e.first_name} ${e.last_name}`})).sort((e,a)=>e.text.localeCompare(a.text)),onFilter:(e,a)=>`${a.Student.first_name} ${a.Student.last_name}`.includes(e)}},{title:"Class Type",key:"class_type",render:(e,a)=>a.class_type.name,sorter:(e,a)=>e.class_type.name.localeCompare(a.class_type.name)},{title:"Sum",dataIndex:"amount",key:"amount",sorter:(e,a)=>e.amount-a.amount},{title:"Lessons",dataIndex:"num_lessons",key:"num_lessons",sorter:(e,a)=>e.num_lessons-a.num_lessons},{title:"Pay with",dataIndex:"payment_method",key:"payment_method",sorter:(e,a)=>e.payment_method.localeCompare(a.payment_method)},{title:"Payment Date",key:"payment_date",render:(e,a)=>a.payment_date?$(a.payment_date).format("YYYY-MM-DD"):"-",sorter:(e,a)=>e.payment_date?a.payment_date?$(e.payment_date).unix()-$(a.payment_date).unix():1:-1}].concat(o.update||o.delete?[{title:"Action",key:"action",render:(e,a)=>t.jsxs(ue,{size:"middle",children:[o.update&&t.jsx(U,{type:"text",icon:t.jsx(re,{}),onClick:()=>W(a),style:{color:"white"}}),o.delete&&t.jsx(U,{type:"text",icon:t.jsx(oe,{}),onClick:()=>Q(a.id),style:{color:"#ef4444"}})]})}]:[]);return T?t.jsx(se,{}):t.jsxs(le,{className:"max-h-[80vh]",children:[t.jsxs("div",{className:"custom-table shadow-md sm:rounded-lg",children:[o.create&&t.jsx("button",{className:"mb-3 inline-flex items-center rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-sm font-medium text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-4 focus:ring-gray-100 dark:border-gray-600 dark:bg-gray-800 dark:text-white dark:hover:border-gray-600 dark:hover:bg-gray-700 dark:focus:ring-gray-700",type:"button",onClick:()=>{P(!0),p(""),g(""),f(""),_(""),C("")},children:"+ Add Payment"}),o.download&&t.jsx("button",{className:"mb-3 ml-2 inline-flex items-center rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-sm font-medium text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-4 focus:ring-gray-100 dark:border-gray-600 dark:bg-gray-800 dark:text-white dark:hover:border-gray-600 dark:hover:bg-gray-700 dark:focus:ring-gray-700",onClick:ee,children:"ðŸ“¥ Download CSV"}),t.jsx(me,{style:{width:"70vw"},className:"custom-table",columns:te,dataSource:F.map((e,a)=>({...e,key:a})),pagination:!1,loading:{spinning:J,size:"large"},scroll:{y:"50vh"},sticky:!0})]}),t.jsxs(c,{show:Z,size:"md",onClose:()=>P(!1),popup:!0,children:[t.jsx(c.Header,{}),t.jsx(c.Body,{children:t.jsxs("div",{className:"space-y-6",children:[t.jsx("h3",{className:"text-xl font-medium text-gray-900 dark:text-white",children:"Add Payment"}),t.jsxs("div",{children:[t.jsx(n,{htmlFor:"student",value:"Student"}),t.jsxs(y,{id:"student",required:!0,value:h,onChange:e=>p(e.target.value),children:[t.jsx("option",{value:"",children:"Select Student"}),Y.map(e=>t.jsxs("option",{value:e.id,children:[e.first_name," ",e.last_name]},e.id))]})]}),t.jsxs("div",{children:[t.jsx(n,{htmlFor:"classType",value:"Class Type"}),t.jsxs(y,{id:"classType",required:!0,value:x,onChange:e=>g(e.target.value),children:[t.jsx("option",{value:"",children:"Select Class Type"}),B.map(e=>t.jsx("option",{value:e.id,children:e.name},e.id))]})]}),t.jsxs("div",{children:[t.jsx(n,{htmlFor:"amount",value:"Total Amount"}),t.jsx(M,{id:"amount",type:"number",value:j,onChange:e=>_(e.target.value)})]}),t.jsxs("div",{children:[t.jsx(n,{htmlFor:"numLessons",value:"Number of Lessons"}),t.jsx(M,{id:"numLessons",type:"number",value:S,onChange:e=>C(e.target.value)})]}),t.jsxs("div",{children:[t.jsx(n,{htmlFor:"paymentMethod",value:"Payment Method"}),t.jsxs(y,{id:"paymentMethod",required:!0,value:v,onChange:e=>f(e.target.value),children:[t.jsx("option",{value:"",children:"Select Payment Method"}),I.map((e,a)=>t.jsx("option",{value:e,children:e},a))]})]}),t.jsxs("div",{children:[t.jsx(n,{htmlFor:"payment_date",value:"Payment Date"}),t.jsx(O,{id:"payment_date",size:"large",style:{width:"100%",backgroundColor:"#374151",borderColor:"#4B5563",color:"white"},value:m,onChange:e=>k(e),placeholder:"Select payment date"})]}),t.jsxs("div",{className:"flex flex-auto",children:[t.jsx(D,{className:"flex-none",onClick:K,children:"Add"}),t.jsx(D,{className:"ml-2 flex-none",onClick:()=>P(!1),children:"Cancel"})]})]})})]}),o.update&&t.jsxs(c,{show:G,size:"md",onClose:()=>w(!1),popup:!0,children:[t.jsx(c.Header,{}),t.jsx(c.Body,{children:t.jsxs("div",{className:"space-y-6",children:[t.jsx("h3",{className:"text-xl font-medium text-gray-900 dark:text-white",children:"Edit Payment"}),t.jsxs("div",{children:[t.jsx(n,{htmlFor:"student",value:"Student"}),t.jsxs(y,{id:"student",required:!0,value:h,onChange:e=>p(e.target.value),children:[t.jsx("option",{value:"",children:"Select Student"}),Y.map(e=>t.jsxs("option",{value:e.id,children:[e.first_name," ",e.last_name]},e.id))]})]}),t.jsxs("div",{children:[t.jsx(n,{htmlFor:"classType",value:"Class Type"}),t.jsxs(y,{id:"classType",required:!0,value:x,onChange:e=>g(e.target.value),children:[t.jsx("option",{value:"",children:"Select Class Type"}),B.map(e=>t.jsx("option",{value:e.id,children:e.name},e.id))]})]}),t.jsx(n,{htmlFor:"amount",value:"Total Amount"}),t.jsx(M,{id:"amount",type:"number",value:j,onChange:e=>_(e.target.value)}),t.jsx(n,{htmlFor:"numLessons",value:"Number of Lessons"}),t.jsx(M,{id:"numLessons",type:"number",value:S,onChange:e=>C(e.target.value)}),t.jsxs("div",{children:[t.jsx(n,{htmlFor:"paymentMethod",value:"Payment Method"}),t.jsxs(y,{id:"paymentMethod",required:!0,value:v,onChange:e=>f(e.target.value),children:[t.jsx("option",{value:"",children:"Select Payment Method"}),I.map((e,a)=>t.jsx("option",{value:e,children:e},a))]})]}),t.jsxs("div",{children:[t.jsx(n,{htmlFor:"edit_payment_date",value:"Payment Date"}),t.jsx(O,{id:"edit_payment_date",size:"large",style:{width:"100%",backgroundColor:"#374151",borderColor:"#4B5563",color:"white"},value:m,onChange:e=>k(e),placeholder:"Select payment date"})]}),t.jsxs("div",{className:"flex flex-auto",children:[t.jsx(D,{className:"flex-none",onClick:X,children:"Update"}),t.jsx(D,{className:"ml-2 flex-none",onClick:()=>w(!1),children:"Cancel"})]})]})})]})]})};export{fe as default};
